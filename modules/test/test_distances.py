import shapelets.compute as sc
from shapelets.compute.distances import DistanceType
import os
import numpy as np

def test_dist_euclidean():
    a = sc.array([[0, 0, 1],
                  [0, 1, 0],
                  [1, 0, 0]], dtype="float32")

    b = sc.array([
        [0, 0, 0, 0, 1, 1, 1, 1],
        [0, 0, 1, 1, 0, 0, 1, 1],
        [0, 1, 0, 1, 0, 1, 0, 1]
    ], dtype="float32")

    assert sc.distances.euclidean(a, b).same_as([
        [1.0000, 0.0000, 1.4142, 1.0000, 1.4142, 1.0000,  1.7321,  1.4142],
        [1.0000, 1.4142, 0.0000, 1.0000, 1.4142, 1.7321,  1.0000,  1.4142],
        [1.0000, 1.4142, 1.4142, 1.7321, 0.0000, 1.0000,  1.0000,  1.4142]
    ])

    assert sc.distances.pdist(b, DistanceType.Euclidean).same_as([
        [0.0000, 1.0000, 1.0000, 1.4142, 1.0000, 1.4142, 1.4142, 1.7321],
        [1.0000, 0.0000, 1.4142, 1.0000, 1.4142, 1.0000, 1.7321, 1.4142],
        [1.0000, 1.4142, 0.0000, 1.0000, 1.4142, 1.7321, 1.0000, 1.4142],
        [1.4142, 1.0000, 1.0000, 0.0000, 1.7321, 1.4142, 1.4142, 1.0000],
        [1.0000, 1.4142, 1.4142, 1.7321, 0.0000, 1.0000, 1.0000, 1.4142],
        [1.4142, 1.0000, 1.7321, 1.4142, 1.0000, 0.0000, 1.4142, 1.0000],
        [1.4142, 1.7321, 1.0000, 1.4142, 1.0000, 1.4142, 0.0000, 1.0000],
        [1.7321, 1.4142, 1.4142, 1.0000, 1.4142, 1.0000, 1.0000, 0.0000]
    ])


def test_dist_manhattan():
    a = sc.array([[0, 0, 1],
                  [0, 1, 0],
                  [1, 0, 0]], dtype="float32")

    b = sc.array([
        [0, 0, 0.0, 0, 1, 1, 1, 1],
        [0, 0, 1.3, 1, 0, 0, 1, 1],
        [0, 1, 0.0, 1, 0, 1, 0, 1]
    ], dtype="float32")

    assert sc.distances.manhattan(a, b).same_as([
        [1.0000, 0.0000, 2.3000, 1.0000, 2.0000, 1.0000, 3.0000, 2.0000],
        [1.0000, 2.0000, 0.3000, 1.0000, 2.0000, 3.0000, 1.0000, 2.0000],
        [1.0000, 2.0000, 2.3000, 3.0000, 0.0000, 1.0000, 1.0000, 2.0000],
    ])

    assert sc.distances.pdist(b, DistanceType.Manhattan).same_as([
        [0.0000, 1.0000, 1.3000, 2.0000, 1.0000, 2.0000, 2.0000, 3.0000],
        [1.0000, 0.0000, 2.3000, 1.0000, 2.0000, 1.0000, 3.0000, 2.0000],
        [1.3000, 2.3000, 0.0000, 1.3000, 2.3000, 3.3000, 1.3000, 2.3000],
        [2.0000, 1.0000, 1.3000, 0.0000, 3.0000, 2.0000, 2.0000, 1.0000],
        [1.0000, 2.0000, 2.3000, 3.0000, 0.0000, 1.0000, 1.0000, 2.0000],
        [2.0000, 1.0000, 3.3000, 2.0000, 1.0000, 0.0000, 2.0000, 1.0000],
        [2.0000, 3.0000, 1.3000, 2.0000, 1.0000, 2.0000, 0.0000, 1.0000],
        [3.0000, 2.0000, 2.3000, 1.0000, 2.0000, 1.0000, 1.0000, 0.0000]
    ])


def test_dist_hamming():
    a = sc.array([[0, 0, 1],
                  [0, 1, 0],
                  [1, 0, 0]], dtype="float32")

    b = sc.array([
        [0, 0, 0, 0, 1, 1, 1, 1],
        [0, 0, 1, 1, 0, 0, 1, 1],
        [0, 1, 0, 1, 0, 1, 0, 1]
    ], dtype="float32")

    assert sc.distances.hamming(a, b).same_as([
        [1, 0, 2, 1, 2, 1, 3, 2],
        [1, 2, 0, 1, 2, 3, 1, 2],
        [1, 2, 2, 3, 0, 1, 1, 2]
    ])
    assert sc.distances.pdist(b, DistanceType.Hamming).same_as([
        [0, 1, 1, 2, 1, 2, 2, 3],
        [1, 0, 2, 1, 2, 1, 3, 2],
        [1, 2, 0, 1, 2, 3, 1, 2],
        [2, 1, 1, 0, 3, 2, 2, 1],
        [1, 2, 2, 3, 0, 1, 1, 2],
        [2, 1, 3, 2, 1, 0, 2, 1],
        [2, 3, 1, 2, 1, 2, 0, 1],
        [3, 2, 2, 1, 2, 1, 1, 0],
    ])


def test_dist_minkowshi():
    a = sc.array([[0, 0, 1],
                  [0, 1, 0],
                  [1, 0, 0]], dtype="float32")

    b = sc.array([
        [0, 0, 0, 0, 1, 1, 1, 1],
        [0, 0, 1, 1, 0, 0, 1, 1],
        [0, 1, 0, 1, 0, 1, 0, 1]
    ], dtype="float32")

    assert sc.distances.minkowshi(a, b, 2.0).same_as(
        sc.distances.euclidean(a, b))
    assert sc.distances.minkowshi(a, b, 1.0).same_as(
        sc.distances.manhattan(a, b))
    assert sc.distances.minkowshi(a, b, 0.5).same_as([
        [1.0000, 0.0000, 4.0000, 1.0000, 4.0000, 1.0000, 9.0000, 4.0000],
        [1.0000, 4.0000, 0.0000, 1.0000, 4.0000, 9.0000, 1.0000, 4.0000],
        [1.0000, 4.0000, 4.0000, 9.0000, 0.0000, 1.0000, 1.0000, 4.0000]
    ])

    assert sc.distances.pdist(b, DistanceType.Minkowshi, p=0.5).same_as([
        [0.0000, 1.0000, 1.0000, 4.0000, 1.0000, 4.0000, 4.0000, 9.0000],
        [1.0000, 0.0000, 4.0000, 1.0000, 4.0000, 1.0000, 9.0000, 4.0000],
        [1.0000, 4.0000, 0.0000, 1.0000, 4.0000, 9.0000, 1.0000, 4.0000],
        [4.0000, 1.0000, 1.0000, 0.0000, 9.0000, 4.0000, 4.0000, 1.0000],
        [1.0000, 4.0000, 4.0000, 9.0000, 0.0000, 1.0000, 1.0000, 4.0000],
        [4.0000, 1.0000, 9.0000, 4.0000, 1.0000, 0.0000, 4.0000, 1.0000],
        [4.0000, 9.0000, 1.0000, 4.0000, 1.0000, 4.0000, 0.0000, 1.0000],
        [9.0000, 4.0000, 4.0000, 1.0000, 4.0000, 1.0000, 1.0000, 0.0000]
    ])


def test_dist_chebyshev():
    a = sc.array([[0, 0, 1],
                  [0, 1, 0],
                  [1, 0, 0]], dtype="float32")

    b = sc.array([
        [0, 0, 0, 0, 1, 1, 1, 1],
        [0, 0, 1, 1, 0, 0, 1, 1],
        [0, 1, 0, 1, 0, 1, 0, 1]
    ], dtype="float32")

    assert sc.distances.chebyshev(a, b).same_as([
        [1.0000, 0.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000],
        [1.0000, 1.0000, 0.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000],
        [1.0000, 1.0000, 1.0000, 1.0000, 0.0000, 1.0000, 1.0000, 1.0000]
    ])

    assert sc.distances.pdist(b, DistanceType.Chebyshev).same_as([
        [0.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000],
        [1.0000, 0.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000],
        [1.0000, 1.0000, 0.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000],
        [1.0000, 1.0000, 1.0000, 0.0000, 1.0000, 1.0000, 1.0000, 1.0000],
        [1.0000, 1.0000, 1.0000, 1.0000, 0.0000, 1.0000, 1.0000, 1.0000],
        [1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 0.0000, 1.0000, 1.0000],
        [1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 0.0000, 1.0000],
        [1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 0.0000]
    ])


def test_dist_sbd():
    a = sc.array([[0, 0, 1],
                  [0, 1, 0],
                  [1, 0, 0]], dtype="float32")

    b = sc.array([
        [0, 0, 0, 1, 1, 1, 1],
        [0, 1, 1, 0, 0, 1, 1],
        [1, 0, 1, 0, 1, 0, 1]
    ], dtype="float32")

    assert sc.distances.sbd(a, b).same_as([
        [0.0000, 0.0000, 0.2929, 0.0000, 0.2929, 0.2929, 0.4226],
        [0.0000, 0.0000, 0.2929, 0.0000, 0.2929, 0.2929, 0.4226],
        [0.0000, 0.0000, 0.2929, 0.0000, 0.2929, 0.2929, 0.4226]
    ])

    assert sc.distances.pdist(b, DistanceType.SBD).same_as([
        [0.0000, 0.0000, 0.2929, 0.0000, 0.2929, 0.2929, 0.4226],
        [0.0000, 0.0000, 0.2929, 0.0000, 0.2929, 0.2929, 0.4226],
        [0.2929, 0.2929, 0.0000, 0.2929, 0.5000, -0.0000, 0.1835],
        [0.0000, 0.0000, 0.2929, 0.0000, 0.2929, 0.2929, 0.4226],
        [0.2929, 0.2929, 0.5000, 0.2929, 0.0000, 0.5000, 0.1835],
        [0.2929, 0.2929, -0.0000, 0.2929, 0.5000, 0.0000, 0.1835],
        [0.4226, 0.4226, 0.1835, 0.4226, 0.1835, 0.1835, 0.0000]
    ])


def test_dist_dtw():
    a = sc.array([[0, 0, 1],
                  [0, 1, 0],
                  [1, 0, 0]], dtype="float32")

    b = sc.array([
        [0, 0, 0, 0, 1, 1, 1, 1],
        [0, 0, 1, 1, 0, 0, 1, 1],
        [0, 1, 0, 1, 0, 1, 0, 1]
    ], dtype="float32")

    assert sc.distances.dtw(a, b).same_as([
        [1.0000, 0.0000, 1.0000, 0.0000, 2.0000, 1.0000, 3.0000, 2.0000],
        [1.0000, 1.0000, 0.0000, 1.0000, 1.0000, 2.0000, 1.0000, 2.0000],
        [1.0000, 2.0000, 1.0000, 3.0000, 0.0000, 1.0000, 0.0000, 2.0000]
    ])

    assert sc.distances.pdist(b, DistanceType.DTW).same_as([
        [0.0000, 1.0000, 1.0000, 2.0000, 1.0000, 2.0000, 2.0000, 3.0000],
        [1.0000, 0.0000, 1.0000, 0.0000, 2.0000, 1.0000, 3.0000, 2.0000],
        [1.0000, 1.0000, 0.0000, 1.0000, 1.0000, 2.0000, 1.0000, 2.0000],
        [2.0000, 0.0000, 1.0000, 0.0000, 3.0000, 1.0000, 2.0000, 1.0000],
        [1.0000, 2.0000, 1.0000, 3.0000, 0.0000, 1.0000, 0.0000, 2.0000],
        [2.0000, 1.0000, 2.0000, 1.0000, 1.0000, 0.0000, 1.0000, 1.0000],
        [2.0000, 3.0000, 1.0000, 2.0000, 0.0000, 1.0000, 0.0000, 1.0000],
        [3.0000, 2.0000, 2.0000, 1.0000, 2.0000, 1.0000, 1.0000, 0.0000]
    ])

def test_dist_mpdist():
    ts = sc.array([1., 2, 3, 1, 2, 3, 4, 5, 6, 0, 0, 1, 1, 2, 2, 4, 5, 1, 1, 9], dtype="float64")
    query = sc.array([0.23595094, 0.9865171, 0.1934413, 0.60880883, 0.55174926, 0.77139988, 0.33529215, 0.63215848], dtype="float64")
    s1 = sc.distances.mpdist(ts, query, 4)
    s2 = sc.distances.mpdist(query,ts, 4)
    assert s1.same_as(s2)
    assert s1.same_as([0.4377])

def test_dist_mpdist_against_data():
    import pathlib
    current_path = pathlib.Path(__file__).parent.absolute()
    ts = np.loadtxt(os.path.join(current_path, 'sampledata.txt'))
    tsb = ts[199:300]
    w = 32
    assert sc.distances.mpdist(ts, tsb, w).same_as([0.])
